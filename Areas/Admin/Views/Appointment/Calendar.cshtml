@model IEnumerable<MyMvcApp.Models.Appointment>
@{
    ViewData["Title"] = "L·ªãch h·∫πn";
}

@section Styles {
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <style>
        /* Th√™m m√†u n·ªÅn x√°m nh·∫°t cho to√†n b·ªô trang */
        .navbar-nav flex-grow-1 {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        
        /* Th√™m m√†u n·ªÅn tr·∫Øng cho card ch·ª©a calendar */
        .card {
            background-color: #ffffff;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .fc-event {
            cursor: pointer;
            border: none !important;
            padding: 2px 4px;
        }
        .fc-event.scheduled {
            background-color: #28a745;
            border-color: #28a745;
        }
        .fc-event.completed {
            background-color: #17a2b8;
            border-color: #17a2b8;
        }
        .fc-event.cancelled {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .fc-event-title {
            font-weight: bold;
            color: white;
        }
        .fc-event-time {
            font-size: 0.9em;
            color: white;
        }
        .fc-toolbar-title {
            font-size: 1.5em !important;
        }
        .fc-button-primary {
            background-color: #007bff !important;
            border-color: #007bff !important;
        }
        .fc-button-primary:hover {
            background-color: #0056b3 !important;
            border-color: #0056b3 !important;
        }
        .fc-button-primary:disabled {
            background-color: #6c757d !important;
            border-color: #6c757d !important;
        }
        .fc-daygrid-day-number {
            font-size: 1.1em;
            font-weight: bold;
        }
        .fc-timegrid-slot {
            height: 2.5em !important;
        }
        .fc-timegrid-slot-label {
            font-size: 0.9em;
        }
        .fc-event-title-container {
            padding: 2px 4px;
        }
        .fc-event-main {
            padding: 2px 4px;
        }
        .fc-event-main-frame {
            padding: 2px 4px;
        }
        .fc-event-time {
            padding: 2px 4px;
        }
        .fc-event-title {
            padding: 2px 4px;
        }
        /* Th√™m style cho c√°c s·ª± ki·ªán */
        .fc-daygrid-event {
            margin: 1px 0;
            border-radius: 3px;
        }
        .fc-daygrid-event-dot {
            border-width: 4px;
        }
        .fc-daygrid-day-events {
            padding: 2px;
        }
        /* Style cho timegrid */
        .fc-timegrid-axis {
            padding: 0 4px;
        }
        .fc-timegrid-slot {
            border-bottom: 1px solid #ddd;
        }
        .fc-timegrid-slot-label {
            font-size: 0.85em;
            color: #666;
        }
        .fc-timegrid-slot-minor {
            border-top: 0;
        }
        .fc-timegrid-slot-minor .fc-timegrid-slot-label {
            display: none;
        }
        .fc-timegrid-col-bg {
            background: #fff;
        }
        .fc-timegrid-col-events {
            margin: 0 2px;
        }
        .fc-timegrid-event {
            margin: 1px 0;
            border-radius: 3px;
        }

        /* Style cho th√¥ng b√°o */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 400px;
        }
        .notification .alert {
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .notification .alert-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .notification .alert-danger {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        /* Simplified modal styles */
        .modal-dialog {
            max-width: 500px;
        }

        /* Ensure form elements are properly styled */
        .modal .form-control,
        .modal .form-select {
            border: 1px solid #ced4da;
            background-color: white;
        }

        .modal .form-control:focus,
        .modal .form-select:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
    </style>
}


    
        <!-- Sidebar -->
        

        <!-- Main content -->
        
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">L·ªãch h·∫πn</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <button type="button" class="btn btn-success me-2" onclick="testModal()">
                        <i class="fas fa-test"></i> Test Modal
                    </button>
                    <a href="@Url.Action("Create")" class="btn btn-primary">
                        <i class="fas fa-plus"></i> T·∫°o l·ªãch h·∫πn m·ªõi
                    </a>
                </div>
            </div>

            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            <div class="card">
                <div class="card-body">
                    <div id="calendar"></div>
                </div>
            </div>
        

<!-- Appointment Details Modal -->
<div class="modal fade" id="appointmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi ti·∫øt l·ªãch h·∫πn</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>B·ªánh nh√¢n:</strong>
                    <span id="modalPatientName"></span>
                </div>
                <div class="mb-3">
                    <strong>D·ªãch v·ª•:</strong>
                    <span id="modalServiceName"></span>
                </div>
                <div class="mb-3">
                    <strong>Nha sƒ©:</strong>
                    <span id="modalDentistName"></span>
                </div>
                <div class="mb-3">
                    <strong>Th·ªùi gian:</strong>
                    <span id="modalTime"></span>
                </div>
                <div class="mb-3">
                    <strong>Tr·∫°ng th√°i:</strong>
                    <span id="modalStatus"></span>
                </div>
                <div class="mb-3">
                    <strong>Ghi ch√∫:</strong>
                    <p id="modalNotes" class="mb-0"></p>
                </div>
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <button type="button" class="btn btn-success" id="markCompletedBtn">
                        <i class="fas fa-check"></i> ƒê√°nh d·∫•u ho√†n th√†nh
                    </button>
                </div>
                <a href="#" class="btn btn-primary" id="modalEditBtn">
                    <i class="fas fa-edit"></i> Ch·ªânh s·ª≠a
                </a>
                <button type="button" class="btn btn-danger" id="deleteAppointmentBtn">
                    <i class="fas fa-trash"></i> X√≥a
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Appointment Modal -->
<div class="modal fade" id="createAppointmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">T·∫°o l·ªãch h·∫πn m·ªõi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createAppointmentForm">
                    @Html.AntiForgeryToken()
                    <div class="mb-3">
                        <label class="form-label">B·ªánh nh√¢n</label>
                        <select class="form-select" name="PatientId" required>
                            <option value="">-- Ch·ªçn b·ªánh nh√¢n --</option>
                            @if (ViewBag.Patients != null)
                            {
                                @foreach (var patient in ViewBag.Patients)
                                {
                                    <option value="@patient.Value">@patient.Text</option>
                                }
                            }
                            else
                            {
                                <option value="" disabled>Kh√¥ng c√≥ d·ªØ li·ªáu b·ªánh nh√¢n</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">D·ªãch v·ª•</label>
                        <select class="form-select" name="ServiceId" required>
                            <option value="">-- Ch·ªçn d·ªãch v·ª• --</option>
                            @if (ViewBag.Services != null)
                            {
                                @foreach (var service in ViewBag.Services)
                                {
                                    <option value="@service.Value">@service.Text</option>
                                }
                            }
                            else
                            {
                                <option value="" disabled>Kh√¥ng c√≥ d·ªØ li·ªáu d·ªãch v·ª•</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nha sƒ©</label>
                        <select class="form-select" name="DentistId" required>
                            <option value="">-- Ch·ªçn nha sƒ© --</option>
                            @if (ViewBag.Dentists != null)
                            {
                                @foreach (var dentist in ViewBag.Dentists)
                                {
                                    <option value="@dentist.Value">@dentist.Text</option>
                                }
                            }
                            else
                            {
                                <option value="" disabled>Kh√¥ng c√≥ d·ªØ li·ªáu nha sƒ©</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ng√†y h·∫πn</label>
                        <input type="date" class="form-control" name="AppointmentDate" required readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Gi·ªù b·∫Øt ƒë·∫ßu</label>
                        <input type="time" class="form-control" name="StartTime" required readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Gi·ªù k·∫øt th√∫c</label>
                        <input type="time" class="form-control" name="EndTime" required readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ghi ch√∫</label>
                        <textarea class="form-control" name="Notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveAppointmentBtn">
                    <i class="fas fa-save"></i> L∆∞u
                </button>
                <button type="button" class="btn btn-secondary" id="cancelAppointmentBtn">H·ªßy</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>
    <script>
        // Simple initialization without conflicts
        console.log('üìÖ Calendar page loaded');
    </script>
    <script>
        // H√†m t·∫°o m√†u ng·∫´u nhi√™n
        function getRandomColor() {
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEEAD',
                '#D4A5A5', '#9B59B6', '#3498DB', '#E67E22', '#2ECC71',
                '#F1C40F', '#1ABC9C', '#E74C3C', '#34495E', '#16A085'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // H√†m t·∫°o m√†u t·ª´ ID
        function getColorFromId(id) {
            const colors = [
                '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEEAD',
                '#D4A5A5', '#9B59B6', '#3498DB', '#E67E22', '#2ECC71',
                '#F1C40F', '#1ABC9C', '#E74C3C', '#34495E', '#16A085'
            ];
            return colors[id % colors.length];
        }

        $(document).ready(function() {
            console.log('üìÖ Calendar initialization started');

            // Check if required libraries are loaded
            if (typeof FullCalendar === 'undefined') {
                console.error('FullCalendar is not loaded');
                alert('FullCalendar kh√¥ng ƒë∆∞·ª£c t·∫£i. Vui l√≤ng t·∫£i l·∫°i trang.');
                return;
            }

            console.log('‚úÖ All libraries loaded successfully');

            // Debug ViewBag data
            console.log('ViewBag.Patients count:', @(ViewBag.Patients?.Count ?? 0));
            console.log('ViewBag.Services count:', @(ViewBag.Services?.Count ?? 0));
            console.log('ViewBag.Dentists count:', @(ViewBag.Dentists?.Count ?? 0));

            // Check user authentication
            console.log('User authenticated:', @(User.Identity?.IsAuthenticated.ToString().ToLower() ?? "false"));
            console.log('User roles:', '@string.Join(",", User.Claims.Where(c => c.Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/role").Select(c => c.Value))');

            var calendarEl = document.getElementById('calendar');
            if (!calendarEl) {
                console.error('Calendar element not found');
                alert('Kh√¥ng t√¨m th·∫•y element calendar. Vui l√≤ng t·∫£i l·∫°i trang.');
                return;
            }

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                buttonText: {
                    today: 'H√¥m nay',
                    month: 'Th√°ng',
                    week: 'Tu·∫ßn',
                    day: 'Ng√†y'
                },
                locale: 'vi',
                slotMinTime: '08:00:00',
                slotMaxTime: '20:00:00',
                allDaySlot: false,
                slotDuration: '00:30:00',
                selectable: true,
                selectMirror: true,
                dayMaxEvents: true,
                nowIndicator: true,
                businessHours: {
                    daysOfWeek: [1, 2, 3, 4, 5, 6],
                    startTime: '08:00',
                    endTime: '20:00',
                },
                events: {
                    url: '@Url.Action("GetAppointments")',
                    failure: function() {
                        alert('C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu l·ªãch h·∫πn!');
                    }
                },
                eventClick: function(info) {
                    showAppointmentDetails(info.event);
                },
                select: function(info) {
                    console.log('Calendar select event triggered:', info);

                    // Unselect the calendar selection immediately to prevent conflicts
                    calendar.unselect();

                    try {
                        // Add a small delay to ensure calendar unselect is processed
                        setTimeout(function() {
                            showCreateAppointmentModal(info.start, info.end);
                        }, 100);
                    } catch (error) {
                        console.error('Error in select handler:', error);
                        alert('C√≥ l·ªói x·∫£y ra khi m·ªü form t·∫°o l·ªãch h·∫πn. Vui l√≤ng th·ª≠ l·∫°i.');
                    }
                },
                eventDidMount: function(info) {
                    let color;
                    // N·∫øu l·ªãch h·∫πn ƒë√£ ho√†n th√†nh, s·ª≠ d·ª•ng m√†u xanh l√° c√¢y
                    if (info.event.extendedProps.status === 'Completed') {
                        color = '#28a745'; // M√†u xanh l√° c√¢y
                        info.el.classList.add('completed');
                    } else if (info.event.extendedProps.status === 'Cancelled') {
                        color = '#dc3545'; // M√†u ƒë·ªè cho l·ªãch ƒë√£ h·ªßy
                        info.el.classList.add('cancelled');
                    } else {
                        // C√°c l·ªãch h·∫πn kh√°c s·∫Ω c√≥ m√†u ng·∫´u nhi√™n
                        color = getColorFromId(info.event.id);
                        info.el.classList.add('scheduled');
                    }

                    // √Åp d·ª•ng m√†u cho s·ª± ki·ªán
                    info.el.style.backgroundColor = color;
                    info.el.style.borderColor = color;
                }
            });
            calendar.render();

            function showAppointmentDetails(event) {
                try {
                    $('#modalPatientName').text(event.extendedProps.patientName || 'N/A');
                    $('#modalServiceName').text(event.extendedProps.serviceName || 'N/A');
                    $('#modalDentistName').text(event.extendedProps.dentistName || 'N/A');
                    $('#modalTime').text(formatTime(event.start) + ' - ' + formatTime(event.end));
                    $('#modalStatus').text(getStatusText(event.extendedProps.status));
                    $('#modalNotes').text(event.extendedProps.notes || 'Kh√¥ng c√≥ ghi ch√∫');
                    $('#modalEditBtn').attr('href', '@Url.Action("Edit")/' + event.id);

                    // ·∫®n/hi·ªán n√∫t ƒë√°nh d·∫•u ho√†n th√†nh d·ª±a v√†o tr·∫°ng th√°i
                    if (event.extendedProps.status === 'Completed') {
                        $('#markCompletedBtn').hide();
                    } else {
                        $('#markCompletedBtn').show();
                    }

                    // L∆∞u ID c·ªßa l·ªãch h·∫πn v√†o data attribute
                    $('#appointmentModal').data('appointment-id', event.id);

                    // Show modal using Bootstrap API
                    var modalElement = document.getElementById('appointmentModal');
                    var modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } catch (error) {
                    console.error('Error showing appointment details:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi hi·ªÉn th·ªã chi ti·∫øt l·ªãch h·∫πn.');
                }
            }

            function showCreateAppointmentModal(start, end) {
                console.log('üîÑ Showing create appointment modal');

                // Reset form first
                document.getElementById('createAppointmentForm').reset();

                // Set date and time values
                document.querySelector('input[name="AppointmentDate"]').value = start.toISOString().split('T')[0];
                document.querySelector('input[name="StartTime"]').value = start.toTimeString().slice(0, 5);
                document.querySelector('input[name="EndTime"]').value = end.toTimeString().slice(0, 5);

                // Use Bootstrap Modal API properly
                var modalElement = document.getElementById('createAppointmentModal');
                var modal = new bootstrap.Modal(modalElement, {
                    backdrop: true,
                    keyboard: true,
                    focus: true
                });
                modal.show();

                console.log('‚úÖ Modal displayed using Bootstrap API');
            }

            function formatTime(date) {
                return date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            }

            function getStatusText(status) {
                switch(status) {
                    case 'Scheduled': return 'ƒê√£ l√™n l·ªãch';
                    case 'Completed': return 'ƒê√£ ho√†n th√†nh';
                    case 'Cancelled': return 'ƒê√£ h·ªßy';
                    case 'No-show': return 'Kh√¥ng ƒë·∫øn';
                    default: return status;
                }
            }

            // Auto-calculate end time based on service duration
            $('select[name="ServiceId"]').change(function() {
                var serviceId = $(this).val();
                if (serviceId) {
                    $.get(`/Appointment/GetServiceDuration/${serviceId}`, function(duration) {
                        var startTime = $('input[name="StartTime"]').val();
                        if (startTime) {
                            var [hours, minutes] = startTime.split(':');
                            var startDate = new Date();
                            startDate.setHours(parseInt(hours), parseInt(minutes));
                            var endDate = new Date(startDate.getTime() + duration * 60000);
                            var endTimeStr = endDate.toTimeString().slice(0, 5);
                            // Ch·ªâ c·∫≠p nh·∫≠t EndTime n·∫øu ch∆∞a c√≥ gi√° tr·ªã
                            if (!$('input[name="EndTime"]').val()) {
                                $('input[name="EndTime"]').val(endTimeStr);
                            }
                        }
                    });
                }
            });

            // Cho ph√©p ch·ªânh s·ª≠a th·ªùi gian k·∫øt th√∫c
            $('input[name="EndTime"]').on('change', function() {
                var startTime = $('input[name="StartTime"]').val();
                var endTime = $(this).val();
                
                if (startTime && endTime) {
                    var [startHours, startMinutes] = startTime.split(':');
                    var [endHours, endMinutes] = endTime.split(':');
                    
                    var startDate = new Date();
                    startDate.setHours(parseInt(startHours), parseInt(startMinutes));
                    
                    var endDate = new Date();
                    endDate.setHours(parseInt(endHours), parseInt(endMinutes));
                    
                    if (endDate <= startDate) {
                        showErrorMessage('Th·ªùi gian k·∫øt th√∫c ph·∫£i sau th·ªùi gian b·∫Øt ƒë·∫ßu');
                        $(this).val('');
                    }
                }
            });

            // Handle appointment creation
            $('#saveAppointmentBtn').on('click', function() {
                console.log('Save appointment button clicked');

                var form = document.getElementById('createAppointmentForm');
                if (!form.checkValidity()) {
                    console.log('Form validation failed');
                    form.reportValidity();
                    return;
                }

                var formData = new FormData(form);
                var data = {};
                formData.forEach((value, key) => {
                    data[key] = value;
                });

                console.log('Form data collected:', data);

                // Parse date and time
                var appointmentDate = new Date(data.AppointmentDate);
                var [startHours, startMinutes] = data.StartTime.split(':').map(Number);
                var [endHours, endMinutes] = data.EndTime.split(':').map(Number);

                // Create datetime objects
                var startDateTime = new Date(appointmentDate);
                startDateTime.setHours(startHours, startMinutes, 0, 0);

                var endDateTime = new Date(appointmentDate);
                endDateTime.setHours(endHours, endMinutes, 0, 0);

                // Get current date and time
                var now = new Date();
                var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                // Check if appointment date is in the past
                if (appointmentDate < today) {
                    showNotification('error', 'Kh√¥ng th·ªÉ t·∫°o l·ªãch h·∫πn trong qu√° kh·ª©.');
                    return;
                }

                // Check if start time is before current time for today's appointments
                if (appointmentDate.getTime() === today.getTime()) {
                    if (startDateTime < now) {
                        showNotification('error', 'Th·ªùi gian b·∫Øt ƒë·∫ßu ph·∫£i sau th·ªùi gian hi·ªán t·∫°i.');
                        return;
                    }
                }

                // Check if end time is after start time
                if (endDateTime <= startDateTime) {
                    showNotification('error', 'Th·ªùi gian k·∫øt th√∫c ph·∫£i sau th·ªùi gian b·∫Øt ƒë·∫ßu.');
                    return;
                }

                // Check if appointment is within business hours (8:00 - 20:00)
                var businessStart = new Date(appointmentDate);
                businessStart.setHours(8, 0, 0, 0);
                
                var businessEnd = new Date(appointmentDate);
                businessEnd.setHours(20, 0, 0, 0);

                if (startDateTime < businessStart || endDateTime > businessEnd) {
                    showNotification('error', 'L·ªãch h·∫πn ph·∫£i n·∫±m trong gi·ªù l√†m vi·ªác (8:00 - 20:00).');
                    return;
                }

                // Format the data for the server
                var appointmentData = {
                    PatientId: parseInt(data.PatientId),
                    ServiceId: parseInt(data.ServiceId),
                    DentistId: data.DentistId,
                    AppointmentDate: appointmentDate.toISOString().split('T')[0],
                    StartTime: startDateTime.toTimeString().slice(0, 8),
                    EndTime: endDateTime.toTimeString().slice(0, 8),
                    Notes: data.Notes || '',
                    Status: 'Scheduled'
                };

                // Disable save button and show loading state
                var saveBtn = $('#saveAppointmentBtn');
                var originalBtnText = saveBtn.html();
                saveBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> ƒêang l∆∞u...');

                console.log('Sending AJAX request with data:', appointmentData);

                $.ajax({
                    url: '@Url.Action("Create")',
                    type: 'POST',
                    data: appointmentData,
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        console.log('AJAX Success response:', response);
                        if (response.success) {
                            // Close modal using Bootstrap API
                            var modalElement = document.getElementById('createAppointmentModal');
                            var modal = bootstrap.Modal.getInstance(modalElement);
                            if (modal) {
                                modal.hide();
                            }

                            // Refresh calendar
                            calendar.refetchEvents();
                            alert('L·ªãch h·∫πn ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!');
                        } else {
                            var errorMessage = response.errors ? response.errors.join('\n') : 'C√≥ l·ªói x·∫£y ra khi t·∫°o l·ªãch h·∫πn.';
                            console.log('Server returned errors:', response.errors);
                            alert('L·ªói: ' + errorMessage);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.log('AJAX Error - Status:', status);
                        console.log('AJAX Error - Error:', error);
                        console.log('AJAX Error - Response:', xhr.responseText);
                        console.log('AJAX Error - Status Code:', xhr.status);

                        var errorMessage = 'C√≥ l·ªói x·∫£y ra khi t·∫°o l·ªãch h·∫πn.';
                        if (xhr.responseJSON && xhr.responseJSON.errors) {
                            errorMessage = xhr.responseJSON.errors.join('<br>');
                        } else if (xhr.status === 401) {
                            errorMessage = 'B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.';
                        } else if (xhr.status === 403) {
                            errorMessage = 'B·∫°n kh√¥ng c√≥ quy·ªÅn t·∫°o l·ªãch h·∫πn. Vui l√≤ng li√™n h·ªá qu·∫£n tr·ªã vi√™n.';
                        }
                        showNotification('error', errorMessage);
                        console.error('Error:', error);
                    },
                    complete: function() {
                        // Restore save button state
                        saveBtn.prop('disabled', false).html(originalBtnText);
                    }
                });
            });

            // Simple notification function
            function showNotification(type, message) {
                alert((type === 'success' ? 'Th√†nh c√¥ng: ' : 'L·ªói: ') + message);
            }

            // Test function to check modal
            window.testModal = function() {
                console.log('üß™ Testing modal functionality');
                var now = new Date();
                var end = new Date(now.getTime() + 90 * 60000); // 90 minutes later
                showCreateAppointmentModal(now, end);
            }

            // X·ª≠ l√Ω s·ª± ki·ªán ƒë√°nh d·∫•u ho√†n th√†nh
            $('#markCompletedBtn').on('click', function() {
                var appointmentId = $('#appointmentModal').data('appointment-id');
                if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒë√°nh d·∫•u l·ªãch h·∫πn n√†y ƒë√£ ho√†n th√†nh?')) {
                    $.ajax({
                        url: '@Url.Action("MarkAsCompleted")',
                        type: 'POST',
                        data: { id: appointmentId },
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function(response) {
                            if (response.success) {
                                var modalElement = document.getElementById('appointmentModal');
                                var modal = bootstrap.Modal.getInstance(modalElement);
                                if (modal) {
                                    modal.hide();
                                }
                                calendar.refetchEvents();
                                showNotification('success', 'ƒê√£ ƒë√°nh d·∫•u l·ªãch h·∫πn ho√†n th√†nh!');
                            } else {
                                showNotification('error', response.errors.join('<br>'));
                            }
                        },
                        error: function(xhr, status, error) {
                            showNotification('error', 'C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t tr·∫°ng th√°i. Vui l√≤ng th·ª≠ l·∫°i.');
                            console.error('Error:', error);
                        }
                    });
                }
            });

            // X·ª≠ l√Ω s·ª± ki·ªán x√≥a l·ªãch h·∫πn
            $('#deleteAppointmentBtn').on('click', function() {
                var appointmentId = $('#appointmentModal').data('appointment-id');
                if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªãch h·∫πn n√†y?')) {
                    $.ajax({
                        url: '@Url.Action("Delete")',
                        type: 'POST',
                        data: { id: appointmentId },
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function(response) {
                            if (response.success) {
                                var modalElement = document.getElementById('appointmentModal');
                                var modal = bootstrap.Modal.getInstance(modalElement);
                                if (modal) {
                                    modal.hide();
                                }
                                calendar.refetchEvents();
                                showNotification('success', 'ƒê√£ x√≥a l·ªãch h·∫πn th√†nh c√¥ng!');
                            } else {
                                showNotification('error', response.errors.join('<br>'));
                            }
                        },
                        error: function(xhr, status, error) {
                            showNotification('error', 'C√≥ l·ªói x·∫£y ra khi x√≥a l·ªãch h·∫πn. Vui l√≤ng th·ª≠ l·∫°i.');
                            console.error('Error:', error);
                        }
                    });
                }
            });

            // Handle cancel button click
            $('#cancelAppointmentBtn').on('click', function() {
                console.log('Cancel button clicked');
                var modalElement = document.getElementById('createAppointmentModal');
                var modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
            });

            // Refresh calendar every 5 minutes
            setInterval(function() {
                calendar.refetchEvents();
            }, 150000);
        });
    </script>
} 