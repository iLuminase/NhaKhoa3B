@{
    ViewData["Title"] = "Demo MoMo Payment";
}


    
        <!-- Sidebar -->
        

        <!-- Main content -->
        
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Demo MoMo Payment Integration</h1>
            </div>

            
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-mobile-alt"></i> MoMo Payment Demo</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle"></i> Th√¥ng tin Demo:</h6>
                                <ul>
                                    <li>ƒê√¢y l√† m√¥i tr∆∞·ªùng test/sandbox c·ªßa MoMo</li>
                                    <li>Kh√¥ng c√≥ giao d·ªãch th·∫≠t ƒë∆∞·ª£c th·ª±c hi·ªán</li>
                                    <li>QR Code ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông cho m·ªói giao d·ªãch</li>
                                    <li>C√≥ th·ªÉ test c·∫£ thanh to√°n ti·ªÅn m·∫∑t v√† MoMo</li>
                                </ul>
                            </div>

                            <form id="demoPaymentForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label>T√™n kh√°ch h√†ng:</label>
                                            <input type="text" class="form-control" id="customerName" value="Nguy·ªÖn VƒÉn A" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label>D·ªãch v·ª•:</label>
                                            <input type="text" class="form-control" id="serviceName" value="Tr√°m rƒÉng" readonly>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label>S·ªë ti·ªÅn:</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="amount" value="150000" min="1000" max="50000000">
                                                <span class="input-group-text">VNƒê</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label>M√¥ t·∫£:</label>
                                            <input type="text" class="form-control" id="orderInfo" value="Thanh to√°n d·ªãch v·ª• nha khoa">
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-primary btn-lg w-100" onclick="createMoMoDemo()">
                                            <i class="fas fa-qrcode"></i> T·∫°o QR MoMo Demo
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-success btn-lg w-100" onclick="simulateCashPayment()">
                                            <i class="fas fa-money-bill-wave"></i> M√¥ ph·ªèng thanh to√°n ti·ªÅn m·∫∑t
                                        </button>
                                    </div>
                                </div>

                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <button type="button" class="btn btn-warning btn-sm" onclick="testQRSimple()">
                                            <i class="fas fa-bug"></i> Test QR Simple
                                        </button>
                                        <button type="button" class="btn btn-info btn-sm" onclick="debugQRLibraries()">
                                            <i class="fas fa-info"></i> Debug Libraries
                                        </button>
                                        <button type="button" class="btn btn-secondary btn-sm" onclick="testModal()">
                                            <i class="fas fa-window-maximize"></i> Test Modal
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="fas fa-cogs"></i> C·∫•u h√¨nh MoMo</h6>
                        </div>
                        <div class="card-body">
                            <small>
                                <strong>Partner Code:</strong> MOMO<br>
                                <strong>Environment:</strong> Test<br>
                                <strong>Endpoint:</strong> test-payment.momo.vn<br>
                                <strong>Request Type:</strong> captureWallet<br>
                                <strong>Language:</strong> vi
                            </small>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="fas fa-list"></i> L·ªãch s·ª≠ Demo</h6>
                        </div>
                        <div class="card-body">
                            <div id="demoHistory">
                                <p class="text-muted">Ch∆∞a c√≥ giao d·ªãch demo n√†o</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- K·∫øt qu·∫£ Demo -->
            <div class="row mt-4" id="demoResult" style="display: none;">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-receipt"></i> K·∫øt qu·∫£ Demo</h5>
                        </div>
                        <div class="card-body">
                            <div id="demoContent">
                                <!-- N·ªôi dung demo s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        

<!-- Modal QR Code -->
<div class="modal fade" id="qrDemoModal" tabindex="-1" aria-labelledby="qrDemoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="qrDemoModalLabel">
                    <i class="fas fa-qrcode"></i> Demo QR Code MoMo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qrDemoContainer">
                    <!-- QR Code demo s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                </div>
                <div class="alert alert-warning mt-3">
                    <strong>L∆∞u √Ω:</strong> ƒê√¢y ch·ªâ l√† demo. QR Code n√†y kh√¥ng th·ªÉ s·ª≠ d·ª•ng ƒë·ªÉ thanh to√°n th·∫≠t.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-success" onclick="simulatePaymentSuccess()">
                    <i class="fas fa-check"></i> M√¥ ph·ªèng thanh to√°n th√†nh c√¥ng
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script>
        let demoTransactions = [];

        function createMoMoDemo() {
            const amount = document.getElementById('amount').value;
            const orderInfo = document.getElementById('orderInfo').value;
            const customerName = document.getElementById('customerName').value;

            if (!amount || amount < 1000) {
                alert('S·ªë ti·ªÅn ph·∫£i √≠t nh·∫•t 1,000 VNƒê');
                return;
            }

            // T·∫°o d·ªØ li·ªáu demo
            const orderId = 'DEMO_' + Date.now();
            const demoData = {
                orderId: orderId,
                amount: amount,
                orderInfo: orderInfo,
                customerName: customerName,
                timestamp: new Date().toLocaleString('vi-VN'),
                status: 'Pending'
            };

            // T·∫°o QR Code demo
            const qrData = `DEMO_MOMO:${orderId}:${amount}:${orderInfo}`;

            document.getElementById('qrDemoContainer').innerHTML = `
                <div id="qrcode-demo"></div>
                <p class="mt-3"><strong>M√£ ƒë∆°n h√†ng:</strong> ${orderId}</p>
                <p><strong>S·ªë ti·ªÅn:</strong> ${parseInt(amount).toLocaleString('vi-VN')} VNƒê</p>
                <p><strong>M√¥ t·∫£:</strong> ${orderInfo}</p>
            `;

            // T·∫°o QR code v·ªõi fallback
            try {
                if (typeof QRCode !== 'undefined') {
                    QRCode.toCanvas(document.getElementById('qrcode-demo'), qrData, {
                        width: 256,
                        height: 256
                    }, function (error) {
                        if (error) {
                            console.error('QR Code error:', error);
                            generateQRFallback(qrData, orderId, amount, orderInfo);
                        }
                    });
                } else {
                    generateQRFallback(qrData, orderId, amount, orderInfo);
                }
            } catch (e) {
                console.error('QR Code exception:', e);
                generateQRFallback(qrData, orderId, amount, orderInfo);
            }

            // L∆∞u v√†o l·ªãch s·ª≠ demo
            demoTransactions.push(demoData);
            updateDemoHistory();

            // Hi·ªÉn th·ªã modal v·ªõi Bootstrap 5
            const modal = new bootstrap.Modal(document.getElementById('qrDemoModal'));
            modal.show();
        }

        function simulateCashPayment() {
            const amount = document.getElementById('amount').value;
            const orderInfo = document.getElementById('orderInfo').value;
            const customerName = document.getElementById('customerName').value;

            if (!amount || amount < 1000) {
                alert('S·ªë ti·ªÅn ph·∫£i √≠t nh·∫•t 1,000 VNƒê');
                return;
            }

            const orderId = 'CASH_' + Date.now();
            const demoData = {
                orderId: orderId,
                amount: amount,
                orderInfo: orderInfo,
                customerName: customerName,
                timestamp: new Date().toLocaleString('vi-VN'),
                status: 'Success',
                paymentMethod: 'Cash'
            };

            demoTransactions.push(demoData);
            updateDemoHistory();

            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            showDemoResult(demoData);

            alert('M√¥ ph·ªèng thanh to√°n ti·ªÅn m·∫∑t th√†nh c√¥ng!');
        }

        function simulatePaymentSuccess() {
            if (demoTransactions.length > 0) {
                const lastTransaction = demoTransactions[demoTransactions.length - 1];
                lastTransaction.status = 'Success';
                lastTransaction.paymentMethod = 'MoMo';

                updateDemoHistory();
                showDemoResult(lastTransaction);

                const modal = bootstrap.Modal.getInstance(document.getElementById('qrDemoModal'));
                modal.hide();
                alert('M√¥ ph·ªèng thanh to√°n MoMo th√†nh c√¥ng!');
            }
        }

        function updateDemoHistory() {
            const historyContainer = document.getElementById('demoHistory');

            if (demoTransactions.length === 0) {
                historyContainer.innerHTML = '<p class="text-muted">Ch∆∞a c√≥ giao d·ªãch demo n√†o</p>';
                return;
            }

            let historyHtml = '';
            demoTransactions.slice(-5).reverse().forEach(transaction => {
                const statusClass = transaction.status === 'Success' ? 'success' : 'warning';
                historyHtml += `
                    <div class="border-bottom pb-2 mb-2">
                        <small>
                            <strong>${transaction.orderId}</strong><br>
                            ${parseInt(transaction.amount).toLocaleString('vi-VN')} VNƒê<br>
                            <span class="badge bg-${statusClass}">${transaction.status}</span><br>
                            <span class="text-muted">${transaction.timestamp}</span>
                        </small>
                    </div>
                `;
            });

            historyContainer.innerHTML = historyHtml;
        }

        function showDemoResult(transaction) {
            const resultContainer = document.getElementById('demoContent');

            resultContainer.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Th√¥ng tin giao d·ªãch:</h6>
                        <ul class="list-unstyled">
                            <li><strong>M√£ ƒë∆°n h√†ng:</strong> ${transaction.orderId}</li>
                            <li><strong>Kh√°ch h√†ng:</strong> ${transaction.customerName}</li>
                            <li><strong>S·ªë ti·ªÅn:</strong> ${parseInt(transaction.amount).toLocaleString('vi-VN')} VNƒê</li>
                            <li><strong>Ph∆∞∆°ng th·ª©c:</strong> ${transaction.paymentMethod || 'MoMo'}</li>
                            <li><strong>Tr·∫°ng th√°i:</strong> <span class="badge bg-success">${transaction.status}</span></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>H√≥a ƒë∆°n demo:</h6>
                        <div class="border p-3">
                            <div class="text-center">
                                <h6>H√ìA ƒê∆†N DEMO</h6>
                                <p>Ph√≤ng kh√°m nha khoa</p>
                                <hr>
                                <p><strong>D·ªãch v·ª•:</strong> ${transaction.orderInfo}</p>
                                <p><strong>T·ªïng ti·ªÅn:</strong> ${parseInt(transaction.amount).toLocaleString('vi-VN')} VNƒê</p>
                                <p><strong>Ng√†y:</strong> ${transaction.timestamp}</p>
                                <hr>
                                <small class="text-muted">ƒê√¢y l√† h√≥a ƒë∆°n demo</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('demoResult').style.display = 'block';
        }

        function generateQRFallback(qrData, orderId, amount, orderInfo) {
            console.log('Using QR Server API fallback...');

            // S·ª≠ d·ª•ng QR Server API
            const qrServerUrl = `https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=${encodeURIComponent(qrData)}`;

            document.getElementById('qrcode-demo').innerHTML = `
                <img src="${qrServerUrl}" alt="QR Code" class="img-fluid" style="max-width: 256px;"
                     onload="console.log('QR Server API successful')"
                     onerror="showQRError()">
                <p class="text-info mt-2"><small>üì° Generated using QR Server API</small></p>
            `;
        }

        function showQRError() {
            document.getElementById('qrcode-demo').innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle"></i> Kh√¥ng th·ªÉ t·∫°o QR Code</h6>
                    <p>C√≥ l·ªói x·∫£y ra khi t·∫°o m√£ QR. Vui l√≤ng th·ª≠ l·∫°i sau.</p>
                    <button class="btn btn-primary btn-sm" onclick="location.reload()">
                        <i class="fas fa-redo"></i> Th·ª≠ l·∫°i
                    </button>
                </div>
            `;
        }

        // Debug function
        function debugQRLibraries() {
            console.log('QRCode library available:', typeof QRCode !== 'undefined');
            console.log('Bootstrap available:', typeof bootstrap !== 'undefined');

            if (typeof QRCode === 'undefined') {
                console.error('QRCode library not loaded!');
            }
            if (typeof bootstrap === 'undefined') {
                console.error('Bootstrap library not loaded!');
            }
        }

        function testQRSimple() {
            console.log('Testing simple QR generation...');

            const testData = 'Test QR Code - Simple';
            const qrServerUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(testData)}`;

            // T·∫°o modal test
            const testModal = document.createElement('div');
            testModal.innerHTML = `
                <div class="modal fade" id="testModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Test QR Code</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center">
                                <img src="${qrServerUrl}" alt="Test QR" class="img-fluid">
                                <p class="mt-2">Test QR Code: ${testData}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(testModal);
            const modal = new bootstrap.Modal(document.getElementById('testModal'));
            modal.show();
        }

        function testModal() {
            console.log('Testing modal functionality...');

            // Test modal c∆° b·∫£n
            const modal = new bootstrap.Modal(document.getElementById('qrDemoModal'));

            // Th√™m test content
            document.getElementById('qrcode-demo').innerHTML = `
                <div class="alert alert-info">
                    <h6>Modal Test</h6>
                    <p>Modal ƒëang ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng!</p>
                    <p>Bootstrap version: ${bootstrap.Tooltip.VERSION || 'Unknown'}</p>
                </div>
            `;

            document.getElementById('qr-info-demo').innerHTML = `
                <p><strong>Test Modal:</strong> SUCCESS</p>
                <p><strong>Time:</strong> ${new Date().toLocaleString()}</p>
            `;

            modal.show();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('MoMo Demo page loaded');
            debugQRLibraries();

            // Test c√°c th∆∞ vi·ªán c·∫ßn thi·∫øt
            setTimeout(() => {
                console.log('Page fully loaded, running tests...');
                if (typeof QRCode === 'undefined') {
                    console.warn('QRCode library not available, will use fallback');
                }
                if (typeof bootstrap === 'undefined') {
                    console.error('Bootstrap not available!');
                }
            }, 1000);
        });
    </script>
}
